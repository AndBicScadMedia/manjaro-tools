#!/bin/sh

[[ -r /opt/livecd/util.sh ]] && source /opt/livecd/util.sh

load_profile_config "/opt/livecd/profile.conf"

[[ -r /opt/livecd/util-livecd.sh ]] && source /opt/livecd/util-livecd.sh

CONSOLEFONT="$(kernel_cmdline vconsole.font)"
CONSOLEMAP="$(kernel_cmdline vconsole.font.map)"
PACMAN_LNG="pacman --config /opt/livecd/pacman-lng.conf --noconfirm --noprogressbar"
arch=$(uname -m)

echo "update fstab for swap" > /var/log/livecd.log

# scan_swap
## Systemd should do it
# should or should not?
# [[ -d /run/openrc ]] && configure_swap
configure_swap

echo "set locale" >> /var/log/livecd.log

# set language
configure_language
locale-gen

echo "configure system" >> /var/log/livecd.log

# add BROWSER var
configure_env

configure_machine_id

echo "configure sudoers" >> /var/log/livecd.log

# do_fix_perms
configure_sudo

echo "depmod extramodules" >> /var/log/livecd.log

# depmod extramodules
depmod $(cat /usr/lib/modules/$(uname -r)/extramodules/version)

install_localization

if [[ ${autologin} != "false" ]] ; then
    configure_displaymanager_autologin
fi

echo "configure root password" >> /var/log/livecd.log

configure_user_root /
cp -a /etc/skel/. /root/

# configure documentation
[[ -e "/etc/skel/Manjaro/Beginner_User_Guide.pdf" ]] && ln -sf \
/etc/skel/Manjaro/Beginner_User_Guide.pdf "/home/${username}/Desktop/Beginner User Guide.pdf"

# check if we are running inside a virtual machine and unistall kalu
[[ -e "/usr/bin/kalu" ]] && rm_kalu /

configure_alsa /

# save settings
alsactl -f /etc/asound.state store &>/dev/null


